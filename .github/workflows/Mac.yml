name: macOS BlueStacks Environment

on: workflow_dispatch

jobs:
  macos-bluestacks:
    runs-on: macos-latest
    
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          tags: tag:ci
      
      - name: Check Virtualization Support
        run: |
          echo "=== Checking Virtualization Support ==="
          sysctl -a | grep -i hv_support || echo "No kern.hv_support (normal on newer macOS)"
          sysctl -a | grep -i hypervisor || echo "Hypervisor flag check complete"
          echo ""
          echo "=== CPU Information ==="
          sysctl -n machdep.cpu.brand_string || true
          echo ""
          echo "=== macOS Version ==="
          sw_vers
      
      - name: Setup Environment for BlueStacks
        run: |
          echo "=== Installing Dependencies ==="
          brew install --cask osxfuse || true
          sudo mkdir -p /mnt
          sudo chmod 777 /mnt
          echo "Environment prepared for emulator installation"
          echo ""
          echo "=== Available Disk Space ==="
          df -h
      
      - name: Get Tailscale IP
        run: |
          echo "======================================"
          echo "Connect via VNC to this Tailscale IP:"
          tailscale ip -4
          echo "Password: bluestacks123"
          echo "======================================"
      
      - name: Enable Screen Sharing (VNC)
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers -privs -all
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw -vncpw bluestacks123
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -restart -agent -console
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate
          echo "VNC enabled successfully"
      
      - name: Set Display Resolution
        run: |
          /Library/Application Support/VMware Tools/vmware-resolutionSet 1920 1080 || \
          /Library/Application Support/VMware Tools/vmware-resolutionSet 1680 1050 || \
          echo "Using default resolution"
      
      - name: Prepare BlueStacks Directory
        run: |
          mkdir -p ~/Library/BlueStacks
          mkdir -p ~/Documents/BlueStacks
          echo "export PATH=$PATH:~/Library/BlueStacks\\ App\\ Player/Runtime" >> ~/.zshrc
          echo "Directories prepared"
      
      - name: tmate session
        uses: mxschmitt/action-tmate@v3
      
      - name: Keep Session Alive
        if: always()
        run: |
          echo "================================================"
          echo "Session is now ready!"
          echo ""
          echo "Connect via VNC from your Tailscale network:"
          echo "  VNC Address: $(tailscale ip -4):5900"
          echo "  Password: bluestacks123"
          echo ""
          echo "You can also SSH with tmate using the connection string shown in the logs."
          echo ""
          echo "Then manually:"
          echo "1. Download BlueStacks from browser"
          echo "2. Install BlueStacks.dmg"
          echo "3. Accept security permissions"
          echo ""
          echo "BlueStacks ADB will be at:"
          echo "  ~/Library/BlueStacks App Player/Runtime/uHD-Adb"
          echo ""
          echo "Session will stay alive for 6 hours..."
          echo "================================================"
          sleep 21600
